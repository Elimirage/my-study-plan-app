import json
from ai import call_yandex_lite

PROFILE_FUNDAMENTALS = {
    "Информационные технологии": [
        "математ", "алгоритм", "программирован", "базы данных",
        "архитектур", "сет", "операционн", "моделирован"
    ],
    "Педагогика": [
        "педагог", "психолог", "методик", "диагностик",
        "воспитание", "обучение", "возрастн"
    ],
    "Юриспруденция": [
        "прав", "закон", "гражданск", "уголовн",
        "конституционн", "административн", "процесс"
    ],
    "Экономика": [
        "экономик", "финанс", "бухгалтер", "статистик",
        "макро", "микро", "анализ данных"
    ],
    "Психология": [
        "психолог", "когнитив", "возрастн", "диагностик",
        "психотерап", "личност"
    ],
    "Менеджмент": [
        "менеджмент", "управлен", "маркетинг",
        "проект", "организац", "бизнес"
    ],
    "Дизайн": [
        "дизайн", "график", "композиция",
        "цвет", "визуал", "макет"
    ]
}

def is_fundamental(name: str, profile: str):
    """
    Определяет, является ли дисциплина фундаментальной для профиля.
    """
    name = name.lower()

    keys = PROFILE_FUNDAMENTALS.get(profile, [])

    if any(k in name for k in keys):
        return True

    soft = [
        "культур", "истор", "философ", "психолог",
        "коммуник", "soft", "самоменедж", "управление временем",
        "риторик", "социолог"
    ]
    if any(k in name for k in soft):
        return False

    return False

def generate_disciplines(profile, min_fund=12, min_var=25):
    """
    Генерация фундаментальных и вариативных дисциплин под профиль.
    """

    prompt = f"""
Ты — методист вуза РФ.

Профиль: "{profile}"

Сгенерируй дисциплины ДВУХ типов:

1) ФУНДАМЕНТАЛЬНЫЕ — ключевые дисциплины профиля.
2) ВАРИАТИВНЫЕ — прикладные, расширяющие.

Сгенерируй:
- минимум {min_fund} фундаментальных
- минимум {min_var} вариативных

Верни строго JSON:
{{
  "fundamental": [{{"name": "Название"}}],
  "variative": [{{"name": "Название"}}]
}}
"""

    raw = call_yandex_lite(
        [{"role": "user", "text": prompt}],
        temperature=0.25,
        max_tokens=2500
    )

    try:
        start = raw.index("{")
        end = raw.rindex("}") + 1
        data = json.loads(raw[start:end])
    except:
        return []

    fund = data.get("fundamental", [])
    var = data.get("variative", [])

    for d in fund:
        d["block_hint"] = "обязательная"
    for d in var:
        d["block_hint"] = "вариативная"

    return fund + var
